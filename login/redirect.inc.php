<?php


////////////////////////////////////////////////////////////////////////////////
// EVALUATE A PATH TO SEE IF REDIRECTION IS POSSIBLE
// DO NOT REDIRECT TO DOMAINS OUTSIDE OF OUR ORIGINS LIST
////////////////////////////////////////////////////////////////////////////////
function canredir($path) {
	global $af;

	$parts = parse_url($path);

	if (empty($parts)) return false;

	if (empty($parts['scheme'])) {
		return empty($parts['host']);
	}

	if (empty($parts['host'])) return false;

	return in_array(
		$parts['scheme'] . '://' . $parts['host'],
		$af->config->origins
	);
}




////////////////////////////////////////////////////////////////////////////////
// ??
////////////////////////////////////////////////////////////////////////////////
$redirect	= $get->sessionClear('redirect');
if (!empty($redirect)) {
	if (canredir($redirect)) $afurl->redirect($redirect, 302);
}




////////////////////////////////////////////////////////////////////////////////
// ??
////////////////////////////////////////////////////////////////////////////////
$referer	= $get->sessionClear('referer');
if (!empty($referer)  &&  $referer !== $afurl(['login'], $afurl)) {
	if (canredir($referer)) $afurl->redirect($referer, 302);
}




////////////////////////////////////////////////////////////////////////////////
// ??
////////////////////////////////////////////////////////////////////////////////
if (!empty($get->redirect)) {
	if (canredir($get->redirect)) $afurl->redirect($get->redirect, 302);
}




////////////////////////////////////////////////////////////////////////////////
// ??
////////////////////////////////////////////////////////////////////////////////
if (empty($af->config->session['redirect'])) {
	$afurl->redirect([]);
}




////////////////////////////////////////////////////////////////////////////////
// REDIRECT TO ROOT / HOME PAGE
////////////////////////////////////////////////////////////////////////////////
if ($af->config->session['redirect'] === 'root') {
	$afurl->redirect([]);
}




////////////////////////////////////////////////////////////////////////////////
// REDIRECT TO CURRENT USER'S PROFILE
////////////////////////////////////////////////////////////////////////////////
if ($af->config->session['redirect'] === 'profile') {
	if (!empty($user->user_url)) {
		$afurl->redirect([$user->user_url], 302);
	} else {
		$afurl->redirect([$user->user_id], 302);
	}
}




////////////////////////////////////////////////////////////////////////////////
// ??
////////////////////////////////////////////////////////////////////////////////
if (canredir($af->config->session['redirect'])) {
	$afurl->redirect($af->config->session['redirect']);
}




////////////////////////////////////////////////////////////////////////////////
// JUST ERROR, SOMETHING IS SERIOUSLY WRONG
////////////////////////////////////////////////////////////////////////////////
error400('Unable to redirect. Possible hacking attempt?');
